name: Deploy to EC2

on:
  workflow_run:
    workflows: ['Docker Image CI']
    types:
      - completed

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: Pull Docker Image
        run: sudo docker pull ghcr.io/yju-okura/minori_gin:latest

      - name: Delete Old Docker Container
        run: sudo docker rm -f minori-gin-container || true

      - name: Delete Old Docker Images
        run: |
          IMAGE_ID=$(sudo docker images -q ghcr.io/yju-okura/minori_gin:latest)
          sudo docker images -q | grep -v $IMAGE_ID | xargs -r sudo docker rmi

      - name: Run Docker Container
        run: |
          sudo docker run -d \
          -p 80:8080 \
          --env-file /volume/.env \
          --restart always \
          --name minori-gin-container \
          ghcr.io/yju-okura/minori_gin:latest
